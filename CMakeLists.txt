# ğŸ“˜ ebpf_file_monitor é¡¹ç›®é¡¶å±‚ CMake æ„å»ºæ–‡ä»¶
# åŸºäº eBPF çš„æ–‡ä»¶æ“ä½œç”Ÿå‘½å‘¨æœŸè¿½è¸ªä¸æ•°æ®æ¬ºéª—ç³»ç»Ÿ

cmake_minimum_required(VERSION 3.16)
project(ebpf_file_monitor VERSION 1.0.0 LANGUAGES C CXX)

# è®¾ç½® C++ æ ‡å‡†
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# è®¾ç½® C æ ‡å‡†
set(CMAKE_C_STANDARD 11)
set(CMAKE_C_STANDARD_REQUIRED ON)

# ç¼–è¯‘é€‰é¡¹
set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -Wextra -O2")
set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -Wall -Wextra -O2")

# è°ƒè¯•æ¨¡å¼é¢å¤–é€‰é¡¹
if(CMAKE_BUILD_TYPE STREQUAL "Debug")
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -g -DDEBUG")
    set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -g -DDEBUG")
endif()

# åŒ…å«ç›®å½•
include_directories(${CMAKE_SOURCE_DIR}/include)

# è®¾ç½® libbpf é™æ€åº“è·¯å¾„
set(LIBBPF_DIR ${CMAKE_SOURCE_DIR}/external/libbpf)
set(LIBBPF_INCLUDE_DIR ${LIBBPF_DIR}/include)
set(LIBBPF_LIB_DIR ${LIBBPF_DIR}/lib)

# æ£€æŸ¥ libbpf é™æ€åº“æ˜¯å¦å­˜åœ¨
if(NOT EXISTS ${LIBBPF_DIR})
    message(FATAL_ERROR "libbpf ç›®å½•ä¸å­˜åœ¨: ${LIBBPF_DIR}")
endif()

if(NOT EXISTS ${LIBBPF_INCLUDE_DIR})
    message(FATAL_ERROR "libbpf å¤´æ–‡ä»¶ç›®å½•ä¸å­˜åœ¨: ${LIBBPF_INCLUDE_DIR}")
endif()

# æŸ¥æ‰¾ libbpf é™æ€åº“æ–‡ä»¶
find_library(LIBBPF_STATIC_LIB
    NAMES libbpf.a bpf
    PATHS ${LIBBPF_LIB_DIR} ${LIBBPF_DIR}/src ${LIBBPF_DIR}
    NO_DEFAULT_PATH
)

if(NOT LIBBPF_STATIC_LIB)
    message(FATAL_ERROR "æœªæ‰¾åˆ° libbpf é™æ€åº“æ–‡ä»¶ï¼Œè¯·æ£€æŸ¥è·¯å¾„: ${LIBBPF_LIB_DIR}")
endif()

message(STATUS "æ‰¾åˆ° libbpf é™æ€åº“: ${LIBBPF_STATIC_LIB}")

# æ·»åŠ  libbpf åŒ…å«ç›®å½•
include_directories(${LIBBPF_INCLUDE_DIR})
include_directories(${LIBBPF_INCLUDE_DIR}/uapi)

# æ£€æŸ¥å¿…è¦çš„å·¥å…·
find_program(CLANG_EXEC clang)
find_program(LLVM_STRIP_EXEC llvm-strip)

if(NOT CLANG_EXEC)
    message(FATAL_ERROR "æœªæ‰¾åˆ° clang ç¼–è¯‘å™¨ï¼Œè¯·å®‰è£… clang/llvm")
endif()

if(NOT LLVM_STRIP_EXEC)
    message(FATAL_ERROR "æœªæ‰¾åˆ° llvm-strip å·¥å…·ï¼Œè¯·å®‰è£… llvm å·¥å…·é“¾")
endif()

# åˆ›å»ºæ—¥å¿—ç›®å½•
file(MAKE_DIRECTORY ${CMAKE_SOURCE_DIR}/tests/log)

# æ·»åŠ å­ç›®å½•
add_subdirectory(src/ebpf)
add_subdirectory(src/user)
add_subdirectory(tests)

# å®‰è£…ç›®æ ‡
install(TARGETS ebpf_file_monitor
        RUNTIME DESTINATION bin)

# æ‰“å°æ„å»ºä¿¡æ¯
message(STATUS "==========================================")
message(STATUS "é¡¹ç›®: ebpf_file_monitor")
message(STATUS "ç‰ˆæœ¬: ${PROJECT_VERSION}")
message(STATUS "æ„å»ºç±»å‹: ${CMAKE_BUILD_TYPE}")
message(STATUS "C++ æ ‡å‡†: ${CMAKE_CXX_STANDARD}")
message(STATUS "C æ ‡å‡†: ${CMAKE_C_STANDARD}")
message(STATUS "Clang è·¯å¾„: ${CLANG_EXEC}")
message(STATUS "LLVM Strip è·¯å¾„: ${LLVM_STRIP_EXEC}")
message(STATUS "libbpf é™æ€åº“: ${LIBBPF_STATIC_LIB}")
message(STATUS "libbpf å¤´æ–‡ä»¶: ${LIBBPF_INCLUDE_DIR}")
message(STATUS "==========================================")