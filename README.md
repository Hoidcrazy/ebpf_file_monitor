# ebpf_file_monitor

ä¸€ä¸ªåŸºäº eBPF çš„æ–‡ä»¶æ“ä½œç›‘æ§ä¸æ•°æ®æ¬ºéª—é¡¹ç›®ï¼Œæ”¯æŒ Linux å†…æ ¸ 3.1 åŠä»¥ä¸Šç‰ˆæœ¬ï¼Œå…¼å®¹ CentOS 7ã€Ubuntuã€éº’éºŸç­‰ä¸»æµ Linux ç³»ç»Ÿã€‚é¡¹ç›®ä½¿ç”¨ C++ å®ç°ç”¨æˆ·æ€é€»è¾‘ï¼ŒC å®ç°å†…æ ¸æ€ eBPF ç¨‹åºï¼Œé€šè¿‡ hook ç³»ç»Ÿè°ƒç”¨å®æ—¶è¿½è¸ªæ–‡ä»¶ç”Ÿå‘½å‘¨æœŸï¼Œå¹¶å¯åœ¨ `.txt` æ–‡ä»¶è¯»å–é˜¶æ®µåŠ¨æ€ç¯¡æ”¹æ•°æ®ï¼Œæ¬ºéª—ç”¨æˆ·ç¨‹åºã€‚

---

## ğŸ¯ é¡¹ç›®ç›®æ ‡

1. ä½¿ç”¨ eBPF hook `open`ã€`read`ã€`write`ã€`close` å‡½æ•°
2. å®ç°æ–‡ä»¶ç”Ÿå‘½å‘¨æœŸè¿½è¸ªï¼ˆæ‰“å¼€â†’è¯»å–â†’å†™å…¥/å…³é—­ï¼‰ï¼Œå½¢æˆæ§åˆ¶å°ä¿¡æ¯å’Œæ—¥å¿—è¾“å‡º
3. æ„å»º `fd â†’ filepath` å­—å…¸æ˜ å°„ï¼Œåœ¨ç”¨æˆ·æ€è·å–æ–‡ä»¶è·¯å¾„ï¼Œä¿å­˜åœ¨æ—¥å¿—ä¸­
4. è¯†åˆ« `.txt` æ–‡ä»¶ï¼Œåœ¨è¯»å–é˜¶æ®µä¿®æ”¹ç¼“å†²åŒºå†…å®¹ï¼Œå®ç°æ•°æ®æ¬ºéª—ï¼Œå¹¶è¾“å‡ºï¼Œç›¸å…³æ“ä½œä¿å­˜åœ¨æ—¥å¿—ä¸­
5. æ”¯æŒ Linux å†…æ ¸ 3.1 ä»¥ä¸Šï¼Œä¼˜é›…å…¼å®¹è€ç³»ç»Ÿï¼ˆkprobe + perf bufferï¼‰

---

## ğŸ—‚ï¸ é¡¹ç›®ç»“æ„


ebpf_file_monitor/                   # é¡¹ç›®æ ¹ç›®å½•
â”œâ”€â”€ CMakeLists.txt                   # é¡¶å±‚ CMake æ„å»ºæ–‡ä»¶
â”œâ”€â”€ README.md                        # é¡¹ç›®è¯´æ˜æ–‡æ¡£ï¼ˆåŠŸèƒ½/ç»“æ„/æ„å»ºè¯´æ˜ï¼‰
â”œâ”€â”€ include/                         # å…¬å…±å¤´æ–‡ä»¶ç›®å½•
â”‚   â”œâ”€â”€ common.h                     # é€šç”¨å®šä¹‰ã€å¸¸é‡ã€å·¥å…·å®
â”‚   â”œâ”€â”€ logger.h                     # æ—¥å¿—æ¥å£ï¼ˆç”¨æˆ·æ€ï¼‰
â”‚   â”œâ”€â”€ event_types.h                # å†…æ ¸å‘ç”¨æˆ·æ€ä¼ é€’çš„äº‹ä»¶ç»“æ„ä½“å®šä¹‰
â”‚   â””â”€â”€ bpf_loader.h                 # eBPF åŠ è½½å™¨ä¸äº‹ä»¶å¤„ç†ç±»å£°æ˜
â”œâ”€â”€ src/                             # æºç ç›®å½•ï¼ˆç”¨æˆ·æ€ + å†…æ ¸æ€ï¼‰
â”‚   â”œâ”€â”€ user/                        # ç”¨æˆ·æ€ç¨‹åºï¼ˆC++ å®ç°ï¼‰
â”‚   â”‚   â”œâ”€â”€ main.cpp                 # ä¸»ç¨‹åºå…¥å£
â”‚   â”‚   â”œâ”€â”€ logger.cpp               # æ—¥å¿—æ¨¡å—å®ç°
â”‚   â”‚   â”œâ”€â”€ bpf_loader.cpp           # äº‹ä»¶å¤„ç†ã€bufferé€‰æ‹©ã€æ•°æ®è§£æ
â”‚   â”‚   â”œâ”€â”€ skeleton_wrapper.cpp     # eBPF skeleton åŠ è½½å™¨å°è£…
â”‚   â”‚   â””â”€â”€ CMakeLists.txt           # æ„å»ºç”¨æˆ·æ€ç¨‹åº
â”‚   â””â”€â”€ ebpf/                        # eBPF å†…æ ¸ç¨‹åºï¼ˆC å®ç°ï¼‰
â”‚       â”œâ”€â”€ file_monitor.bpf.c       # hook ç³»ç»Ÿè°ƒç”¨é€»è¾‘ï¼ˆopen/read/write/closeï¼‰
â”‚       â”œâ”€â”€ fd_map.bpf.c             # fd â†’ path å“ˆå¸Œè¡¨ç»´æŠ¤
â”‚       â””â”€â”€ CMakeLists.txt           # ç¼–è¯‘ .bpf.c ç¨‹åºå¹¶ç”Ÿæˆ skeleton
â”œâ”€â”€ scripts/                         # è„šæœ¬ç›®å½•
â”‚   â”œâ”€â”€ build.sh                     # ä¸€é”®æ„å»ºè„šæœ¬ï¼ˆCMake + ç¼–è¯‘ï¼‰
â”‚   â””â”€â”€ run.sh                       # å¯åŠ¨ç¨‹åºè„šæœ¬ï¼ˆéœ€è¦ rootï¼‰
â”œâ”€â”€ tools/                           # è¾…åŠ©å·¥å…·/æµ‹è¯•ç”Ÿæˆå™¨
â”‚   â””â”€â”€ txt_generator.cpp            # æ¨¡æ‹Ÿåº”ç”¨ç¨‹åºï¼šæ‰“å¼€å¹¶è¯»å– .txt æ–‡ä»¶
â”œâ”€â”€ tests/                           # å•å…ƒæµ‹è¯•æˆ–é›†æˆæµ‹è¯•ä»£ç 
â”‚   â””â”€â”€ test_basic.cpp               # åŸºç¡€åŠŸèƒ½æµ‹è¯•ï¼ˆå¯é€‰å¯¹æ¥ gtestï¼‰



## âš™ï¸ æŠ€æœ¯è¦ç‚¹

### ç³»ç»Ÿè°ƒç”¨ hook ç­–ç•¥

- ä½¿ç”¨ **kprobe/kretprobe** æ›¿ä»£ fentry/fexitï¼Œå…¼å®¹å†…æ ¸ â‰¥ 3.1
- hook çš„å‡½æ•°åŒ…æ‹¬ï¼š
  - `do_sys_open` / `sys_openat`ï¼ˆè·å–è·¯å¾„ï¼‰
  - `sys_read` / `sys_write`
  - `sys_close`

### æ–‡ä»¶ç”Ÿå‘½å‘¨æœŸç›‘æ§

- åœ¨ open æˆåŠŸè¿”å›åï¼š
  - æå– `fd` å’Œ `filename`ï¼Œå†™å…¥ eBPF å“ˆå¸Œè¡¨ï¼ˆfd_mapï¼‰
- åœ¨ read/write æ—¶ï¼š
  - ä»å“ˆå¸Œè¡¨è·å–å¯¹åº”è·¯å¾„ï¼Œå‘é€ç»™ç”¨æˆ·æ€
- åœ¨ close æ—¶ï¼š
  - åˆ é™¤å¯¹åº” fd æ˜ å°„

### é€šä¿¡æœºåˆ¶ï¼ˆç”¨æˆ·æ€ â†” å†…æ ¸æ€ï¼‰

| æœºåˆ¶           | å†…æ ¸ç‰ˆæœ¬è¦æ±‚ | çŠ¶æ€ | è¯´æ˜ |
|----------------|---------------|------|------|
| **ring buffer** | â‰¥ 5.8         | âœ… æ¨è | é«˜æ•ˆï¼Œlibbpf æ–°æ¥å£ |
| **perf buffer** | â‰¥ 4.4         | âœ… å…¼å®¹ | ç¨³å®šå¹¿æ³›æ”¯æŒ |
| **map fallback**| â‰¥ 3.1         | âœ… Linux 3.1 ä¸“ç”¨ | ç”¨æˆ·æ€è½®è¯¢è¯»å– map |

ğŸ“Œ é¡¹ç›®é€šè¿‡ `BpfLoader` è‡ªåŠ¨æ£€æµ‹å†…æ ¸ç‰ˆæœ¬ï¼Œä¼˜å…ˆä½¿ç”¨ ring bufferï¼Œå…¶æ¬¡ perf bufferï¼Œæœ€åå›é€€è‡³ map è½®è¯¢é€šä¿¡ï¼ˆç”¨äºå…¼å®¹ 3.x ç³»ç»Ÿï¼‰ã€‚

### æ•°æ®æ¬ºéª—æœºåˆ¶

- äº‹ä»¶ä¸­æºå¸¦ `fd`ã€`ç”¨æˆ·ç¼“å†²åŒºåœ°å€`ã€`é•¿åº¦`ã€`æ–‡ä»¶è·¯å¾„`ã€`PID`
- ç”¨æˆ·æ€æ£€æµ‹åˆ°è¯»å– `.txt` æ–‡ä»¶æ—¶ï¼š
  - æ‹¦æˆªäº‹ä»¶æ•°æ®
  - ä¿®æ”¹ç¼“å†²åŒºå†…å®¹ï¼ˆæ›¿æ¢ä¸º `"è¿™æ˜¯ä¸€æ®µfakeå†…å®¹ã€‚"`ï¼‰
  - å†™å…¥åŸç¼“å†²åœ°å€ï¼ˆå¯ä½¿ç”¨ `/proc/self/mem`ï¼‰
- è¾“å‡ºè‡³æ§åˆ¶å°å’Œæ—¥å¿—

> âš ï¸ æ³¨æ„æƒé™éœ€æ±‚ï¼šéœ€è¦ root æƒé™ã€å¯èƒ½éœ€ CAP_SYS_ADMIN æƒé™


## ğŸ§± æ„å»ºä¸è¿è¡Œ

### ç¯å¢ƒä¾èµ–

- Linux å†…æ ¸ â‰¥ 3.1
- clang / llvm â‰¥ 10
- cmake â‰¥ 3.14
- libbpfã€bpftool
- g++ã€makeã€zlibã€pthread
- root æƒé™æ‰§è¡Œ

### ç¼–è¯‘æ–¹å¼

```bash
# è¿›å…¥é¡¹ç›®ç›®å½•
cd ebpf_file_monitor

# æ„å»ºé¡¹ç›®
./scripts/build.sh

# è¿è¡Œç›‘æ§ç¨‹åº
sudo ./scripts/run.sh
